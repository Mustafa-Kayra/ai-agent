<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puter AI 2025 - Pro Workspace</title>
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        :root {
            --bg-app: #0f111a;
            --bg-panel: #1e2130;
            --bg-chat-bubble: #2b2e40;
            --primary: #3b52d4;
            --primary-hover: #2e42b5;
            --text-main: #ffffff;
            --text-muted: #9498a4;
            --border: #2f3345;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-main); }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3e4359; border-radius: 3px; }

        .thinking-process { border-left: 2px solid var(--primary); padding-left: 12px; margin-bottom: 12px; font-size: 0.80rem; color: var(--text-muted); background: rgba(59, 82, 212, 0.05); border-radius: 0 8px 8px 0; padding-top: 8px; padding-bottom: 8px; }
        .thinking-step { display: flex; items-center; gap: 8px; margin-bottom: 4px; opacity: 0.7; transition: all 0.3s; }
        .thinking-step.active { opacity: 1; color: #60a5fa; font-weight: 500; transform: translateX(2px); }
        .thinking-step i { width: 12px; height: 12px; }

        .markdown-body { font-size: 0.95rem; line-height: 1.6; }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body pre { background: #151722; padding: 12px; border-radius: 8px; overflow-x: auto; border: 1px solid #ffffff10; }
        .markdown-body code { font-family: 'Menlo', monospace; background: #2d2d3a; padding: 2px 6px; border-radius: 4px; color: #e2e8f0; font-size: 0.85em; }
        
        /* Model Selector Styling */
        select { -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%239498a4%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 0.7rem top 50%; background-size: 0.65rem auto; padding-right: 2.5rem; }
        optgroup { background: #1e2130; color: #9498a4; font-weight: 600; }
        option { background: #1e2130; color: #fff; padding: 8px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-blue-500 selection:text-white">

    <!-- Left Sidebar (History) -->
    <div id="sidebar-left" class="w-64 flex-shrink-0 flex flex-col border-r border-[#2f3345] bg-[#0f111a] transition-transform duration-300 transform -translate-x-full md:translate-x-0 absolute md:relative z-30 h-full">
        <!-- User Profile -->
        <div class="p-4 border-b border-[#2f3345] flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 flex-1 min-w-0">
                <div id="user-avatar" class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-600 to-purple-600 flex items-center justify-center font-bold text-sm shadow-lg flex-shrink-0">?</div>
                <div class="flex-1 min-w-0">
                    <div id="username" class="truncate font-medium text-sm">Misafir</div>
                    <button onclick="handleAuth()" class="text-xs text-blue-400 hover:text-blue-300 transition-colors">GiriÅŸ Yap</button>
                </div>
            </div>
            <!-- Close Button for Mobile -->
            <button onclick="toggleLeftSidebar()" class="md:hidden text-gray-400 hover:text-white p-1">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- New Chat -->
        <div class="p-4">
            <button onclick="startNewChat()" class="w-full bg-[#3b52d4] hover:bg-[#2e42b5] text-white py-2.5 px-4 rounded-xl font-medium text-sm flex items-center justify-center gap-2 transition-all shadow-lg shadow-blue-900/20">
                <i data-lucide="plus" class="w-4 h-4"></i> Yeni Sohbet
            </button>
        </div>

        <!-- History List -->
        <div class="flex-1 overflow-y-auto px-2 pb-4 space-y-1" id="history-list"></div>
    </div>

    <!-- Center (Chat Area) -->
    <div class="flex-1 flex flex-col relative min-w-0 bg-[#0f111a]">
        <!-- Header -->
        <div class="h-14 border-b border-[#2f3345] flex items-center px-4 justify-between bg-[#0f111a]/95 backdrop-blur z-20">
            <div class="flex items-center gap-3">
                <button onclick="toggleLeftSidebar()" class="md:hidden text-gray-400 hover:text-white"><i data-lucide="menu" class="w-5 h-5"></i></button>
                <h2 class="font-semibold text-sm flex items-center gap-2 text-gray-200">
                    <span id="chat-header-title">Yeni Sohbet</span>
                    <span id="header-status" class="hidden text-[10px] bg-blue-900/30 text-blue-400 px-2 py-0.5 rounded-full animate-pulse">Ä°ÅŸleniyor...</span>
                </h2>
            </div>
            <button onclick="toggleRightSidebar()" class="lg:hidden text-gray-400 hover:text-white"><i data-lucide="settings-2" class="w-5 h-5"></i></button>
        </div>

        <!-- Messages -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 scroll-smooth">
            <div id="empty-state" class="h-full flex flex-col items-center justify-center text-center opacity-60">
                <div class="w-20 h-20 bg-[#1e2130] rounded-2xl flex items-center justify-center mb-6 shadow-xl">
                    <i data-lucide="cpu" class="w-10 h-10 text-[#3b52d4]"></i>
                </div>
                <h3 class="text-xl font-semibold mb-2 text-white">AI Workspace 2025</h3>
                <p class="text-sm text-gray-400 max-w-xs">2025'in en gÃ¼Ã§lÃ¼ modelleri burada. SaÄŸdan modunu ve modelini seÃ§, uÃ§uÅŸa geÃ§.</p>
            </div>
            <div id="messages-list" class="max-w-3xl mx-auto space-y-6 pb-10"></div>
        </div>

        <!-- Input -->
        <div class="p-4 border-t border-[#2f3345] bg-[#0f111a]">
            <div class="max-w-3xl mx-auto relative">
                <div class="relative bg-[#1e2130] rounded-xl border border-[#2f3345] shadow-lg focus-within:border-[#3b52d4] transition-colors">
                    <textarea id="prompt-input" rows="1" class="w-full bg-transparent text-sm text-white p-4 pr-12 resize-none focus:outline-none max-h-40 scrollbar-hide" placeholder="Bir ÅŸeyler sor..."></textarea>
                    <button onclick="handleSendClick()" class="absolute right-2 bottom-2 p-2 bg-[#3b52d4] hover:bg-[#2e42b5] text-white rounded-lg transition-colors">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="text-center mt-2 text-[10px] text-gray-600 flex justify-center gap-3">
                    <span>âš¡ CanlÄ± DÃ¼ÅŸÃ¼nme</span><span>â€¢</span><span>ðŸ”’ Bulut HafÄ±za</span><span>â€¢</span><span>ðŸš€ Auto-Deploy</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Sidebar (Settings) -->
    <div id="sidebar-right" class="w-80 flex-shrink-0 border-l border-[#2f3345] bg-[#0f111a] flex flex-col transition-transform duration-300 transform translate-x-full lg:translate-x-0 absolute right-0 lg:relative z-30 h-full">
        
        <div class="p-5 border-b border-[#2f3345] flex justify-between items-start">
            <div>
                <h3 class="text-sm font-semibold mb-1 text-white">Kontrol Paneli</h3>
                <p class="text-xs text-gray-500">Mod ve Motor AyarlarÄ±</p>
            </div>
            <!-- Close Button for Mobile -->
            <button onclick="toggleRightSidebar()" class="lg:hidden text-gray-400 hover:text-white p-1">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="p-5 space-y-6 overflow-y-auto flex-1">
            
            <!-- Mode Selector -->
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-3 uppercase tracking-wider">Ã‡alÄ±ÅŸma Modu</label>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="setMode('general')" id="btn-mode-general" class="mode-btn active p-3 rounded-lg border border-[#2f3345] bg-[#1e2130] text-left hover:border-[#3b52d4] transition-all flex items-center gap-3 group">
                        <div class="w-8 h-8 rounded bg-blue-500/10 flex items-center justify-center text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition-colors"><i data-lucide="message-square" class="w-4 h-4"></i></div>
                        <div>
                            <div class="text-xs font-bold text-gray-200">Genel Sohbet</div>
                            <div class="text-[10px] text-gray-500">GÃ¼nlÃ¼k asistan, hÄ±zlÄ± cevaplar.</div>
                        </div>
                    </button>
                    
                    <button onclick="setMode('deepsearch')" id="btn-mode-deepsearch" class="mode-btn p-3 rounded-lg border border-[#2f3345] bg-[#1e2130] text-left hover:border-[#3b52d4] transition-all flex items-center gap-3 group">
                        <div class="w-8 h-8 rounded bg-purple-500/10 flex items-center justify-center text-purple-400 group-hover:bg-purple-500 group-hover:text-white transition-colors"><i data-lucide="globe" class="w-4 h-4"></i></div>
                        <div>
                            <div class="text-xs font-bold text-gray-200">Deep Search</div>
                            <div class="text-[10px] text-gray-500">Akademik araÅŸtÄ±rma, kaynaklÄ±.</div>
                        </div>
                    </button>

                    <button onclick="setMode('coding')" id="btn-mode-coding" class="mode-btn p-3 rounded-lg border border-[#2f3345] bg-[#1e2130] text-left hover:border-[#3b52d4] transition-all flex items-center gap-3 group">
                        <div class="w-8 h-8 rounded bg-green-500/10 flex items-center justify-center text-green-400 group-hover:bg-green-500 group-hover:text-white transition-colors"><i data-lucide="code-2" class="w-4 h-4"></i></div>
                        <div>
                            <div class="text-xs font-bold text-gray-200">Kodlama & Host</div>
                            <div class="text-[10px] text-gray-500">Tek tÄ±kla deploy, temiz kod.</div>
                        </div>
                    </button>

                    <button onclick="setMode('teacher')" id="btn-mode-teacher" class="mode-btn p-3 rounded-lg border border-[#2f3345] bg-[#1e2130] text-left hover:border-[#3b52d4] transition-all flex items-center gap-3 group">
                        <div class="w-8 h-8 rounded bg-yellow-500/10 flex items-center justify-center text-yellow-400 group-hover:bg-yellow-500 group-hover:text-white transition-colors"><i data-lucide="graduation-cap" class="w-4 h-4"></i></div>
                        <div>
                            <div class="text-xs font-bold text-gray-200">Ã–ÄŸrenme UzmanÄ±</div>
                            <div class="text-[10px] text-gray-500">Sokratik metodla Ã¶ÄŸretim.</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Model Selector -->
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-3 uppercase tracking-wider">Yapay Zeka Motoru</label>
                <div class="relative">
                    <select id="model-selector" class="w-full bg-[#1e2130] border border-[#2f3345] text-sm text-gray-200 rounded-lg p-3 focus:ring-1 focus:ring-blue-500 outline-none">
                        <optgroup label="ðŸ”¥ 2025 Flagships (En Ä°yiler)">
                            <option value="openrouter:openai/gpt-5.1">GPT 5.1 (Preview)</option>
                            <option value="claude-opus-4-5">Claude Opus 4.5 (Native)</option>
                            <option value="openrouter:google/gemini-3">Gemini 3 Ultra</option>
                            <option value="openrouter:x-ai/grok-3">Grok 3</option>
                            <option value="openrouter:deepseek/deepseek-r1">DeepSeek R1 (Reasoning)</option>
                        </optgroup>

                        <optgroup label="ðŸ§  Anthropic Claude Ailesi">
                            <option value="openrouter:anthropic/claude-3.7-sonnet">Claude 3.7 Sonnet</option>
                            <option value="openrouter:anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                            <option value="openrouter:anthropic/claude-opus-4.1">Claude Opus 4.1</option>
                            <option value="openrouter:anthropic/claude-haiku-4.5">Claude Haiku 4.5</option>
                        </optgroup>

                        <optgroup label="âœ¨ OpenAI GPT & O Serisi">
                            <option value="openrouter:openai/gpt-5">GPT 5</option>
                            <option value="openrouter:openai/gpt-4o">GPT-4o</option>
                            <option value="openrouter:openai/o3">OpenAI o3</option>
                            <option value="openrouter:openai/o3-deep-research">o3 Deep Research</option>
                            <option value="openrouter:openai/gpt-5-image">GPT-5 GÃ¶rsel ModÃ¼lÃ¼</option>
                        </optgroup>

                        <optgroup label="âš¡ Google Gemini">
                            <option value="gemini-3-pro-preview">Gemini 3 Pro (Native)</option>
                            <option value="openrouter:google/gemini-2.5-pro">Gemini 2.5 Pro</option>
                            <option value="openrouter:google/gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash</option>
                        </optgroup>

                        <optgroup label="ðŸŒŒ xAI Grok">
                            <option value="openrouter:x-ai/grok-4.1-fast">Grok 4.1 Fast</option>
                            <option value="openrouter:x-ai/grok-4">Grok 4</option>
                            <option value="openrouter:x-ai/grok-2-1212">Grok 2</option>
                        </optgroup>

                        <optgroup label="ðŸš€ DeepSeek & Ã‡in Modelleri">
                            <option value="openrouter:deepseek/deepseek-chat-v3.1">DeepSeek V3.1</option>
                            <option value="openrouter:deepseek/deepseek-v3.2-exp">DeepSeek V3.2 Exp</option>
                            <option value="openrouter:moonshotai/kimi-k2-thinking">Kimi k2 Thinking</option>
                            <option value="openrouter:z-ai/glm-4.6">GLM 4.6</option>
                        </optgroup>

                        <optgroup label="ðŸ“š DiÄŸerleri (Llama, Mistral vs.)">
                            <option value="openrouter:meta-llama/llama-4-maverick">Llama 4 Maverick</option>
                            <option value="openrouter:meta-llama/llama-3.3-70b-instruct">Llama 3.3 70B</option>
                            <option value="openrouter:qwen/qwen-2.5-72b-instruct">Qwen 2.5 72B</option>
                            <option value="openrouter:mistralai/mistral-large-2411">Mistral Large 2411</option>
                            <option value="openrouter:perplexity/sonar-reasoning-pro">Perplexity Sonar Pro</option>
                        </optgroup>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        let chats = [];
        let activeChatId = null;
        let isUserSignedIn = false;
        
        const MODES = {
            'general': { 
                title: 'Genel Sohbet',
                system: 'Sen Z kuÅŸaÄŸÄ± dilinden anlayan, samimi, kÄ±sa ve Ã¶z konuÅŸan zeki bir asistansÄ±n. Gereksiz resmiyet yapma. Nokta kullanma.',
                steps: ['Mesaj inceleniyor...', 'BaÄŸlam kuruluyor...', 'Cevap Ã¼retiliyor...']
            },
            'deepsearch': { 
                title: 'Deep Search',
                system: 'Sen derinlemesine araÅŸtÄ±rma yapan bir analistsin. CevaplarÄ±nda mutlaka kaynak belirt. Konuyu her aÃ§Ä±dan ele al.',
                steps: ['Sorgu analiz ediliyor...', 'Web kaynaklarÄ± taranÄ±yor (Google & Scholar)...', 'Veriler doÄŸrulanÄ±yor...', 'Ä°Ã§erik sentezleniyor...', 'Kaynaklar ekleniyor...']
            },
            'coding': { 
                title: 'Kodlama',
                system: 'Sen Expert Senior Developer\'sÄ±n. Kod istenirse TEK DOSYA HTML olarak ver. "Deploy" butonu iÃ§in hazÄ±rla.',
                steps: ['Gereksinimler analiz ediliyor...', 'Mimari tasarlanÄ±yor...', 'Kod yazÄ±lÄ±yor...', 'Syntax kontrol ediliyor...', 'Deploy paketi hazÄ±rlanÄ±yor...']
            },
            'teacher': { 
                title: 'Ã–ÄŸretmen',
                system: 'Sen Sokratik bir Ã¶ÄŸretmensin. CevabÄ± direkt verme, sorularla yÃ¶nlendir. Basit anlat.',
                steps: ['Ã–ÄŸrenme seviyesi belirleniyor...', 'Pedagojik yaklaÅŸÄ±m seÃ§iliyor...', 'Analoji kuruluyor...', 'Cevap hazÄ±rlanÄ±yor...']
            }
        };

        // --- INIT ---
        lucide.createIcons();
        initApp();

        async function initApp() {
            try {
                const user = await puter.auth.getUser().catch(() => null);
                if (user) {
                    isUserSignedIn = true;
                    document.getElementById('username').innerText = user.username;
                    document.getElementById('user-avatar').innerText = user.username.charAt(0).toUpperCase();
                    await loadChats();
                }
            } catch(e) {}
            
            if(chats.length === 0) startNewChat();
            else loadChatToUI(chats[0].id);
        }

        // --- CORE CHAT ---
        async function handleSendClick() {
            const text = document.getElementById('prompt-input').value.trim();
            if (!text) return;

            document.getElementById('prompt-input').value = '';
            resizeTextarea();

            if (!activeChatId) startNewChat();
            const chatId = activeChatId; 
            const currentChat = chats.find(c => c.id === chatId);
            
            // User Message
            currentChat.messages.push({ role: 'user', content: text, timestamp: Date.now() });
            updateChatUI(chatId);
            
            // Processing Start
            currentChat.isProcessing = true;
            currentChat.processLog = []; // Log for thinking steps
            renderHistoryList();
            
            const modeKey = currentChat.mode || 'general';
            const modeConfig = MODES[modeKey];
            const modelId = document.getElementById('model-selector').value;

            try {
                // --- LIVE THINKING SIMULATION (ALL MODES) ---
                // Her mod iÃ§in tanÄ±mlÄ± adÄ±mlarÄ± (steps) tek tek oynatÄ±yoruz
                for (const step of modeConfig.steps) {
                    if (!currentChat.isProcessing) break; 
                    
                    currentChat.tempStatus = step;
                    currentChat.processLog.push({ text: step, done: false }); // Log progress
                    
                    // UI Update if active
                    if (activeChatId === chatId) updateThinkingUI(chatId);
                    
                    // Random delay for realism (DeepSearch daha yavaÅŸ)
                    const delay = modeKey === 'deepsearch' ? 1500 : 600; 
                    await new Promise(r => setTimeout(r, delay + Math.random() * 500));
                    
                    // Mark last step as done
                    if(currentChat.processLog.length > 0) currentChat.processLog[currentChat.processLog.length-1].done = true;
                }

                // API Call
                const historyContext = currentChat.messages.slice(-8).map(m => `${m.role}: ${m.content}`).join('\n');
                const fullPrompt = `${modeConfig.system}\n\nGEÃ‡MÄ°Åž:\n${historyContext}\n\nUSER: ${text}`;
                
                const response = await puter.ai.chat(fullPrompt, { model: modelId });
                
                let content = typeof response === 'object' ? (response.message?.content || JSON.stringify(response)) : String(response);
                if(Array.isArray(content)) content = content.join('');

                currentChat.messages.push({ role: 'assistant', content: content, timestamp: Date.now() });

            } catch (err) {
                console.error(err);
                currentChat.messages.push({ role: 'assistant', content: `âš ï¸ Hata: ${err.message || "BaÄŸlantÄ± koptu."}` });
            } finally {
                currentChat.isProcessing = false;
                currentChat.tempStatus = null;
                saveChats();
                renderHistoryList();
                if (activeChatId === chatId) updateChatUI(chatId);
            }
        }

        // --- UI ---
        function updateChatUI(chatId) {
            if (chatId !== activeChatId) return;
            
            const chat = chats.find(c => c.id === chatId);
            const container = document.getElementById('messages-list');
            container.innerHTML = '';
            document.getElementById('empty-state').style.display = chat.messages.length ? 'none' : 'flex';
            document.getElementById('chat-header-title').innerText = chat.title || "Yeni Sohbet";

            // Messages
            chat.messages.forEach(msg => {
                const div = document.createElement('div');
                const isUser = msg.role === 'user';
                div.className = `flex gap-4 ${isUser ? 'flex-row-reverse' : 'flex-row'}`;
                
                const avatarBg = isUser ? 'bg-[#3b52d4]' : 'bg-[#2b2e40] border border-[#2f3345]';
                const icon = isUser ? 'user' : 'bot';
                
                let contentHtml = marked.parse(msg.content);
                
                // Add Coding Deploy Button
                if (!isUser && (chat.mode === 'coding' || msg.content.includes('```html'))) {
                    const match = msg.content.match(/```html([\s\S]*?)```/);
                    if(match) {
                        const code = match[1].trim().replace(/"/g, '&quot;');
                        contentHtml += `<div class="mt-3"><button onclick="deployCode(this)" data-code="${code}" class="text-xs bg-[#3b52d4] hover:bg-[#2e42b5] text-white px-3 py-2 rounded-lg flex items-center gap-2 transition-colors"><i data-lucide="rocket" class="w-3 h-3"></i> CanlÄ±ya Al (Host)</button></div>`;
                    }
                }

                // Add DeepSearch Citations
                if (!isUser && chat.mode === 'deepsearch') {
                    contentHtml += `
                    <div class="mt-3 pt-3 border-t border-white/5 flex flex-wrap gap-2">
                        <div class="text-[10px] text-gray-500 font-bold uppercase tracking-wider flex items-center gap-1"><i data-lucide="book" class="w-3 h-3"></i> Kaynaklar:</div>
                        <span class="text-[10px] bg-[#151722] text-blue-400 px-2 py-1 rounded border border-[#2f3345] hover:border-blue-500 cursor-pointer transition-colors">wikipedia.org</span>
                        <span class="text-[10px] bg-[#151722] text-blue-400 px-2 py-1 rounded border border-[#2f3345] hover:border-blue-500 cursor-pointer transition-colors">researchgate.net</span>
                        <span class="text-[10px] bg-[#151722] text-blue-400 px-2 py-1 rounded border border-[#2f3345] hover:border-blue-500 cursor-pointer transition-colors">github.com</span>
                    </div>`;
                }

                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full ${avatarBg} flex-shrink-0 flex items-center justify-center text-white text-xs shadow-lg"><i data-lucide="${icon}" class="w-4 h-4"></i></div>
                    <div class="max-w-[85%] min-w-0">
                        <div class="p-4 rounded-2xl ${isUser ? 'bg-[#3b52d4] text-white' : 'bg-[#1e2130] text-gray-100 border border-[#2f3345]'} shadow-md markdown-body">
                            ${contentHtml}
                        </div>
                        <div class="text-[10px] text-gray-600 mt-1 px-1 ${isUser ? 'text-right' : 'text-left'} opacity-60">${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                `;
                container.appendChild(div);
            });

            // Thinking Indicator (Appended at bottom if processing)
            if (chat.isProcessing) {
                const thinkingDiv = document.createElement('div');
                thinkingDiv.id = 'thinking-bubble';
                thinkingDiv.className = "flex gap-4";
                thinkingDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-[#2b2e40] flex-shrink-0 flex items-center justify-center text-gray-300 text-xs border border-[#2f3345] animate-pulse"><i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i></div>
                    <div class="max-w-[85%] min-w-0">
                        <div class="p-0 rounded-2xl">
                            <div class="thinking-process rounded-lg border border-[#2f3345] bg-[#151722] p-3 shadow-inner" id="thinking-steps-container">
                                <!-- Steps injected via JS -->
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(thinkingDiv);
                updateThinkingUI(chatId); // Populate steps immediately
            }

            lucide.createIcons();
            container.scrollTo(0, container.scrollHeight);
        }

        function updateThinkingUI(chatId) {
            const container = document.getElementById('thinking-steps-container');
            if (!container) return;
            
            const chat = chats.find(c => c.id === chatId);
            if (!chat || !chat.processLog) return;

            container.innerHTML = chat.processLog.map((log, index) => {
                const isActive = index === chat.processLog.length - 1;
                const icon = log.done ? 'check-circle' : (isActive ? 'loader' : 'circle');
                const color = log.done ? 'text-green-500' : (isActive ? 'text-blue-400 animate-pulse' : 'text-gray-600');
                const spin = isActive && !log.done ? 'animate-spin' : '';
                
                return `
                    <div class="thinking-step ${isActive ? 'active' : ''}">
                        <i data-lucide="${icon}" class="${color} ${spin} w-3 h-3"></i>
                        <span>${log.text}</span>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- CHAT MANAGEMENT ---
        function startNewChat() {
            const id = Date.now().toString();
            // Get active mode from UI buttons
            const activeBtn = document.querySelector('.mode-btn.active');
            const initialMode = activeBtn ? activeBtn.id.replace('btn-mode-', '') : 'general';

            const newChat = {
                id: id,
                title: 'Yeni Sohbet',
                messages: [],
                mode: initialMode,
                timestamp: Date.now(),
                isProcessing: false,
                processLog: []
            };
            chats.unshift(newChat);
            loadChatToUI(id);
            renderHistoryList();
            saveChats();
            
            if(window.innerWidth < 768) document.getElementById('sidebar-left').classList.add('-translate-x-full');
        }

        function loadChatToUI(id) {
            activeChatId = id;
            const chat = chats.find(c => c.id === id);
            if(!chat) return;
            
            setMode(chat.mode || 'general', false);
            updateChatUI(id);
            renderHistoryList();
        }

        function renderHistoryList() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            chats.forEach(chat => {
                const isActive = chat.id === activeChatId;
                const btn = document.createElement('button');
                btn.onclick = () => loadChatToUI(chat.id);
                
                const modeIcon = MODES[chat.mode || 'general'].icon || 'message-square';
                const processingBadge = chat.isProcessing 
                    ? `<div class="absolute right-3 top-3 w-2 h-2 bg-blue-500 rounded-full animate-ping"></div><div class="absolute right-3 top-3 w-2 h-2 bg-blue-500 rounded-full"></div>` 
                    : '';

                btn.className = `w-full text-left p-3 rounded-xl text-sm mb-1 flex items-center gap-3 relative transition-all group border border-transparent
                    ${isActive ? 'bg-[#1e2130] border-[#2f3345] text-white shadow-md' : 'text-gray-400 hover:bg-[#151722] hover:text-gray-200'}`;
                
                btn.innerHTML = `
                    <i data-lucide="message-circle" class="w-4 h-4 opacity-60"></i>
                    <div class="flex-1 min-w-0">
                        <div class="truncate font-medium text-[13px]">${chat.title}</div>
                        <div class="text-[10px] opacity-50 truncate">${chat.isProcessing ? chat.tempStatus || 'Ã‡alÄ±ÅŸÄ±yor...' : new Date(chat.timestamp).toLocaleDateString()}</div>
                    </div>
                    ${processingBadge}
                `;
                list.appendChild(btn);
            });
            lucide.createIcons();
        }

        function setMode(mode, updateChat = true) {
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.remove('active', 'border-[#3b52d4]', 'bg-[#25283a]');
                if(b.id === `btn-mode-${mode}`) b.classList.add('active', 'border-[#3b52d4]', 'bg-[#25283a]');
            });
            
            if (updateChat && activeChatId) {
                const chat = chats.find(c => c.id === activeChatId);
                if (chat) {
                    chat.mode = mode;
                    saveChats();
                }
            }
        }

        // --- UTILS ---
        async function handleAuth() {
            try {
                const user = await puter.auth.signIn();
                isUserSignedIn = true;
                document.getElementById('username').innerText = user.username;
                document.getElementById('user-avatar').innerText = user.username.charAt(0).toUpperCase();
                await loadChats();
            } catch(e) {}
        }

        async function saveChats() {
            if (!isUserSignedIn) return;
            try { await puter.fs.write('chats_pro_v1.json', JSON.stringify(chats)); } catch (e) {}
        }

        async function loadChats() {
            if (!isUserSignedIn) return;
            try {
                const f = await puter.fs.read('chats_pro_v1.json');
                if(f) chats = JSON.parse(await f.text());
                renderHistoryList();
            } catch (e) {}
        }

        async function deployCode(btn) {
            if (!isUserSignedIn) { handleAuth(); return; }
            
            const code = btn.getAttribute('data-code').replace(/&quot;/g, '"');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i>`;
            btn.disabled = true;

            try {
                const randomId = Math.random().toString(36).substring(7);
                const subdomain = `pro-${randomId}`;
                const dir = `www_${randomId}`;
                await puter.fs.mkdir(dir);
                await puter.fs.write(`${dir}/index.html`, code);
                const site = await puter.hosting.create(subdomain, dir);
                
                btn.className = "text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg flex items-center gap-2 transition-colors";
                btn.innerHTML = `<i data-lucide="external-link" class="w-3 h-3"></i> ${site.subdomain}`;
                btn.onclick = () => window.open(`https://${site.subdomain}.puter.site`, '_blank');
            } catch (err) {
                console.error(err);
                btn.innerHTML = `Hata`;
                setTimeout(() => { btn.innerHTML = originalHtml; btn.disabled = false; }, 2000);
            }
        }

        function resizeTextarea() {
            const el = document.getElementById('prompt-input');
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        document.getElementById('prompt-input').addEventListener('input', resizeTextarea);
        document.getElementById('prompt-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendClick();
            }
        });

        function toggleLeftSidebar() { document.getElementById('sidebar-left').classList.toggle('-translate-x-full'); }
        function toggleRightSidebar() { document.getElementById('sidebar-right').classList.toggle('translate-x-full'); }

    </script>
</body>
</html>